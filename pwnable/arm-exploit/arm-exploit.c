#include <stdio.h>
#include <string.h>

struct User {
    char username[32];
    int state;
};

int secure_read(char *buf, int size){
    int a = read(0, buf, size);
    if (a <= 0 ){
        puts("Go way, Hacker!!!");
        exit(0);
    }
    else{
        if (buf[a-1] == 10){
            buf[a-1] = 0;
        }
    }
    return a;
}

int read_int(){
    char ptr[0x10];
    secure_read(ptr, 0x10);
    return atoi(ptr);
}

int logined;
char pass[32];
struct User user;

void genpass(){
    FILE *fp = open("/dev/urandom", 0);
    if (read(fp, pass, 0x10) <= 0){
        close(fp);
        puts("Can not open /dev/random!\nPlease report this bug!\nThank you!");
        exit(0);
    }
    close(fp);
}

int menu(){
    puts("*******************Arm Exploit******************");
    puts("*                                              *");
    puts("* 1 - info                                     *");
    puts("* 2 - login                                    *");
    puts("* 3 - echo                                     *");
    puts("* 4 - change username                          *");
    puts("* 5 - exit                                     *");
    puts("************************************************");
    printf("Your choice: ");
}

void timeout(){
    puts("Time out!");
    exit(0);
}

int init(){
    setbuf(stdin, 0);
    setbuf(stdout, 0);
    setbuf(stderr, 0);
    signal(14, timeout);
    alarm(60);
    genpass();
    puts("**************************Welcome to Arm Exploit**************************");
    puts("*                                                                        *");
    puts("*************************Challenge Created By CNV*************************");
    puts("*   Team: AceBear                                                        *");
    puts("*   My blog: https://chung96vn.blogspot.com/                             *");
    puts("**************************************************************************");
}

void info(){
    if (logined){
        puts("**************************User Info***************************");
        puts("*                                                            *");
        printf("*Username: %s\n", user.username);
        puts("**************************************************************");
        puts("*                                                            *");
        printf("*State: %d\n", user.state, " ");
        puts("**************************************************************");
    }
    else{
        puts("Plese login!");
    }
}

void login(){
    char password[0x20];
    printf("Username: ");
    secure_read(user.username, 0x20);
    printf("password: ");
    secure_read(password, 0x20);
    if (!memcmp(password, pass, 16) && !strcmp(user.username, "root")){
        puts("Admin logined!");
        user.state = 0;
    }
    else{
        puts("Guest logined!");
        user.state = 1;
    }
    logined = 1;
}

void change_username(){
    if (logined){
        char username[0x30];
        memset(username, 0, 0x30);
        printf("New username: ");
        secure_read(username, 0x20);
        strcpy(user.username, username);
        puts("Change username done!");
    }
    else{
        puts("You must login!");
    }
}

void rootecho(){
    while (1){
        printf("root@arm-exploit:~$ ");
        char command[0x80];
        secure_read(command, 0x100);
        if (!strcmp(command, "exit")){
            return;
        }
        if (!strcmp(command, "help")){
            puts("List command:");
            puts("$ echo argument");
            puts("$ exit");
            puts("$ help");
            continue;
        }
        if (memcmp(command, "echo ", 5)){
            puts("Invalid Command! Try help");
            continue;
        }
        puts(&command[5]);
    }
}

void guestecho(){
    while (1){
        printf("guest@arm-exploit:~$ ");
        char command[0x40];
        secure_read(command, 0x40);
        if (!strcmp(command, "exit")){
            return;
        }
        if (!strcmp(command, "help")){
            puts("List command:");
            puts("$ echo argument");
            puts("$ exit");
            puts("$ help");
            continue;
        }
        if (memcmp(command, "echo ", 5)){
            puts("Invalid Command! Try help");
            continue;
        }
        puts(&command[5]);
    }
}

void echo(){
    if(logined){
        if(!user.state && !strcmp(user.username, "root")){
            puts("Welcome root echo!");
            rootecho();
        }
        else{
            puts("Welcome guest echo!");
            guestecho();
        }
    }
    else{
        puts("You must login!");
    }
}

int main(){
    init();
    while (1){
        menu();
        switch (read_int()){
            case 1:
                info();
                break;
            case 2:
                login();
                break;
            case 3:
                echo();
                break;
            case 4:
                change_username();
                break;
            case 5:
                exit(0);
                break;
            default:
                puts("Invalid choice!");
        }
    }
}